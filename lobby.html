<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<script src="https://unpkg.com/centrifuge@3.1.0/dist/centrifuge.js"></script>
<p id="token_jwt" style="display: none">{{.Token}}</p>
<p id="lobby_name" style="display: none">{{.LobbyName}}</p>
<p id="username" style="display: none">{{.Username}}</p>
<script type="text/javascript">
    const client = new Centrifuge("ws://localhost:8000/connection/websocket", {
        token: document.getElementById("token_jwt").innerHTML
    });
    client.on('connecting', function(ctx) {
        console.log('connecting', ctx);
    });

    client.on('connected', function(ctx) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/connect')
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log('connected', ctx);
            } else {
                window.location.replace("/")
            }
        }
        xhr.send()
    });

    client.on('disconnected', function(ctx) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/disconnect')
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log('disconnected', ctx);
            } else {
                window.location.replace("/")
            }
        }
        xhr.send()
    });
    window.onbeforeunload = function () {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/disconnect')
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log('disconnected', ctx);
            } else {
                window.location.replace("/")
            }
        }
        xhr.send()
    }
    client.connect();
    const sub = client.newSubscription(document.getElementById("lobby_name").innerHTML)
    sub.subscribe();
    sub.on('publication', function (ctx) {
        rasp = ctx.data
        const message = document.createElement("p")
        message.innerHTML = `${rasp["user"]}: ${rasp["message"]}`
        document.getElementById("chat").appendChild(message)
    })
    sub.on('subscribing', function(ctx) {
            console.log('subscribing');
    })
    sub.on('subscribed', function(ctx) {
            console.log('subscribed');
    })
    sub.on('unsubscribed', function(ctx) {
            console.log('unsubscribed');
    })

    function sendMessage() {
        const message = document.getElementById('message').value;
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/send')
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
        }
        const data = {user: document.getElementById("username").innerHTML, message:message, channel: document.getElementById("lobby_name").innerHTML}
        xhr.send(JSON.stringify(data))
    }
</script>
<body>
    <h1>{{.LobbyName}}</h1>
    <div id="chat"></div>
    <div>
        <input placeholder="Message" type="text" id="message">
        <button onclick="sendMessage()">Send</button>
    </div>
</body>
</html>