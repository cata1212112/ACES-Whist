<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../style/lobby.css">
    <meta charset="UTF-8">
    <title>Lobby {{.LobbyName}}</title>
</head>
<link rel="stylesheet" href="../style/common_style.css">
<script src="https://unpkg.com/centrifuge@3.1.0/dist/centrifuge.js"></script>
<p id="token_jwt" style="display: none">{{.Token}}</p>
<p id="lobby_name" style="display: none">{{.LobbyName}}</p>
<p id="username" style="display: none">{{.Username}}</p>
<script type="text/javascript">
    const client = new Centrifuge("ws://localhost:8000/connection/websocket", {
        token: document.getElementById("token_jwt").innerHTML
    });
    client.on('connecting', function(ctx) {
        console.log('connecting', ctx);
    });

    client.on('connected', function(ctx) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/connect')
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log('connected', ctx);
            } else {
                window.location.replace("/")
            }
        }
        xhr.send()
    });

    client.on('disconnected', function(ctx) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/disconnect')
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log('disconnected', ctx);
            } else {
                window.location.replace("/")
            }
        }
        xhr.send()
    });
    window.onbeforeunload = function () {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/disconnect')
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log('disconnected', ctx);
            } else {
                window.location.replace("/")
            }
        }
        xhr.send()

        const xhr1 = new XMLHttpRequest();
        xhr1.open("POST", "http://localhost:5000/removeFromLobby")
        xhr1.setRequestHeader("Content-Type", "application/json");
        var requestData = JSON.stringify({
            lobby: document.getElementById("lobby_name").innerHTML,
            name: document.getElementById("username").innerHTML
        });
        xhr1.onload = () => {
            if (xhr1.status === 200) {
                alert("Removed from lobby successfully")
            } else {
                alert("Error removing from lobby")
            }
        }
        xhr1.send(requestData)
    }
    client.connect();
    const sub = client.newSubscription(document.getElementById("lobby_name").innerHTML)
    const xhr = new XMLHttpRequest();
    xhr.open("POST", 'http://localhost:5000/addToLobby')
    xhr.setRequestHeader("Content-Type", "application/json");
    var requestData = JSON.stringify({
        lobby: document.getElementById("lobby_name").innerHTML,
        name: document.getElementById("username").innerHTML
    });
    xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                console.log("Name added to the lobby successfully");


            } else {
                console.error("Error:", xhr.status, xhr.statusText);
            }
        }
    };
    xhr.send(requestData);
    sub.subscribe();
    sub.on('publication', function (ctx) {
        rasp = ctx.data
        const message = document.createElement("p")
        message.innerHTML = `<span style="font-weight:bold;">${rasp["user"]}</span>: ${rasp["message"]}`
        document.getElementById("chat").appendChild(message)
    })
    sub.on('subscribing', function(ctx) {
            console.log('subscribing');
    })
    sub.on('subscribed', function(ctx) {
            console.log('subscribed');
    })
    sub.on('unsubscribed', function(ctx) {
            console.log('unsubscribed');
    })

    function toggleChat() {
        const chat = document.getElementById("container")
        if (chat.style.display === "none") {
            chat.style.display = "flex"
        } else {
            chat.style.display = "none"
        }
    }

    function sendMessage() {
        const message = document.getElementById('message').value;
        if (message.length === 0) {
            return;
        }
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:5000/send')
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {}
        const data = {user: document.getElementById("username").innerHTML, message:message, channel: document.getElementById("lobby_name").innerHTML}
        xhr.send(JSON.stringify(data))
        document.getElementById('message').value = '';
    }
    // xhr.open("GET", 'http://localhost:5000/lobbyMembers/' + document.getElementById("lobby_name").innerHTML)
    // xhr.onload = function () {
    //     console.log(xhr.response)
    //     vec = JSON.parse(xhr.response)
    //     console.log(vec)
    //     var addedMembers = []; // Variabila pentru a tine evidenta membrilor adaugati
    //     for (x in vec) {
    //         console.log(vec[x])
    //         if (!addedMembers.includes(vec[x])) { // Verificam daca membrul exista deja in lista
    //             console.log(vec[x])
    //             var span = document.createElement("span");
    //             span.innerHTML = vec[x];
    //             document.getElementsByClassName("membrii")[0].appendChild(span);
    //             addedMembers.push(vec[x]); // Adaugam membrul in lista de membri adaugati
    //         }
    //     }
    // }
    //
    // xhr.send()
    xhr.open("GET", 'http://localhost:5000/lobbyMembers/' + document.getElementById("lobby_name").innerHTML);
    xhr.onload = function () {
        console.log(xhr.response);
        var vec = JSON.parse(xhr.response);
        console.log(vec);
        var addedMembers = []; // Variabila pentru a tine evidenta membrilor adaugati
        var currentPlayer = document.getElementById("lobby_name").innerHTML; // Numele jucatorului curent

        for (x in vec) {
            console.log(vec[x]);
            if (!addedMembers.includes(vec[x])) { // Verificam daca membrul exista deja in lista
                console.log(vec[x]);
                var span = document.createElement("span");
                span.innerHTML = vec[x];

                if (vec[x] === currentPlayer) { // Membrul curent
                    document.getElementById("carti_jucator").appendChild(span);
                } else { // Membru diferit de cel curent
                    document.getElementById("carti_intoarse_stanga").appendChild(span.cloneNode(true));
                    document.getElementById("carti_intoarse_fata").appendChild(span.cloneNode(true));
                    document.getElementById("carti_intoarse_dreapta").appendChild(span.cloneNode(true));
                }

                addedMembers.push(vec[x]); // Adaugam membrul in lista de membri adaugati
            }
        }
    };

    xhr.send();

</script>
<body>
<div id="upper-wrapper">
    <button id="buton_intoarcere_lobbies" class="action_button pinkish" onclick="window.location.href='/lobbies'">Exit lobby</button>
    <h1 class="lobby-name">{{.LobbyName}} </h1>
    <button id="toggle_chat" class="action_button blueish" onclick="toggleChat()">Chat</button>
</div>

<div class="membrii">
    <h2>Membrii</h2>
</div>
<div id = "container_mare">
<div id="container_joc" style="display: flex">
    <div id = "carti_intoarse_stanga">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
    </div>

    <div id = "carti_intoarse_fata">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
    </div>

    <div id = "carti_intoarse_dreapta">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
        <img src="../deckOfCards/SVG-cards-1.3/red_joker.svg">
    </div>
    <div id="carti_jucator" style="" class="carte_de_joc">
        <img src="../deckOfCards/SVG-cards-1.3/2_of_clubs.svg">
        <img src="../deckOfCards/SVG-cards-1.3/3_of_clubs.svg">
        <img src="../deckOfCards/SVG-cards-1.3/4_of_clubs.svg">
        <img src="../deckOfCards/SVG-cards-1.3/5_of_clubs.svg">
        <img src="../deckOfCards/SVG-cards-1.3/6_of_clubs.svg">
        <img src="../deckOfCards/SVG-cards-1.3/7_of_clubs.svg">
        <img src="../deckOfCards/SVG-cards-1.3/8_of_clubs.svg">


    </div>
</div>
<div id="container" style="">
    <div id="chat">
    </div>
    <div class="chat-input">
        <input placeholder="Message" type="text" id="message">
        <button onclick="sendMessage()" class="send-button">Send</button>
    </div>
</div>
</div>
<!--<h1>{{.Username}}</h1>-->
</body>
</html>